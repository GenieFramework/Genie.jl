<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Working with WebSockets · Genie - The Highly Productive Julia Web Framework</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><script src="../../copy.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../index.html">Genie - The Highly Productive Julia Web Framework</a></span></div><form class="docs-search" action="../search.html"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../index.html">Home</a></li><li><span class="tocitem">Guides</span><ul><li><a class="tocitem" href="../guides/Working_With_Genie_Apps.html">Working with Genie Apps</a></li><li><a class="tocitem" href="../guides/Interactive_environment.html">Using Genie in an interactive environment</a></li><li><a class="tocitem" href="../guides/Simple_API_backend.html">Developing an API backend</a></li><li><a class="tocitem" href="../guides/Genie_Plugins.html">Using Genie Plugins</a></li><li><a class="tocitem" href="../guides/Working_With_Genie_Apps_Intermediary_Topics.html">Working With Genie Apps: Intermediate Topics [WIP]</a></li></ul></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="1--Overview.html">Welcome to Genie</a></li><li><a class="tocitem" href="2--Installing_Genie.html">Installing Genie</a></li><li><a class="tocitem" href="3--Getting_Started.html">Getting started</a></li><li><a class="tocitem" href="4--Developing_Web_Services.html">Creating a web service</a></li><li><a class="tocitem" href="4-1--Developing_MVC_Web_Apps.html">Developing MVC web applications</a></li><li><a class="tocitem" href="5--Handling_Query_Params.html">Handling URI/query params</a></li><li><a class="tocitem" href="6--Working_with_POST_Payloads.html">Working with forms and POST payloads</a></li><li><a class="tocitem" href="7--Using_JSON_Payloads.html">Using JSON payloads</a></li><li><a class="tocitem" href="8--Handling_File_Uploads.html">Uploading files</a></li><li><a class="tocitem" href="9--Publishing_Your_Julia_Code_Online_With_Genie_Apps.html">Adding your libraries into Genie</a></li><li><a class="tocitem" href="10--Loading_Genie_Apps.html">Loading and starting Genie apps</a></li><li><a class="tocitem" href="11--Managing_External_Packages.html">Managing Genie app&#39;s dependencies</a></li><li><a class="tocitem" href="12--Advanced_Routing_Techniques.html">Advanced routing</a></li><li><a class="tocitem" href="13--Initializers.html">Auto-loading configuration code with initializers</a></li><li><a class="tocitem" href="14--The_Secrets_File.html">The secrets file</a></li><li><a class="tocitem" href="15--The_Lib_Folder.html">Auto-loading user libraries</a></li><li><a class="tocitem" href="16--Using_Genie_With_Docker.html">Using Genie with Docker</a></li><li class="is-active"><a class="tocitem" href="17--Working_with_Web_Sockets.html">Working with WebSockets</a><ul class="internal"><li><a class="tocitem" href="#Registering-channels"><span>Registering <code>channels</code></span></a></li><li><a class="tocitem" href="#Setting-up-the-client"><span>Setting up the client</span></a></li><li><a class="tocitem" href="#Try-it!"><span>Try it!</span></a></li><li><a class="tocitem" href="#Summary"><span>Summary</span></a></li></ul></li><li><a class="tocitem" href="80--Force_Compiling_Routes.html">Force compiling route handlers</a></li><li><a class="tocitem" href="90--Deploying_With_Heroku_Buildpacks.html">Deploying to Heroku with Buildpacks</a></li><li><a class="tocitem" href="91--Deploying_Genie_Docker_Apps_on_Heroku.html">Deploying to Heroku with Docker</a></li><li><a class="tocitem" href="92--Deploying_Genie_Server_Apps_with_Nginx.html">Deploying to server with Nginx</a></li></ul></li><li><span class="tocitem">API</span><ul><li><a class="tocitem" href="../api/app.html">App</a></li><li><a class="tocitem" href="../api/appserver.html">AppServer</a></li><li><a class="tocitem" href="../api/assets.html">Assets</a></li><li><a class="tocitem" href="../api/cache.html">Cache</a></li><li><a class="tocitem" href="../api/commands.html">Commands</a></li><li><a class="tocitem" href="../api/configuration.html">Configuration</a></li><li><a class="tocitem" href="../api/cookies.html">Cookies</a></li><li><input class="collapse-toggle" id="menuitem-4-8" type="checkbox"/><label class="tocitem" for="menuitem-4-8"><span class="docs-label">Deploy</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../api/deploy-docker.html">Docker</a></li><li><a class="tocitem" href="../api/deploy-heroku.html">Heroku</a></li></ul></li><li><a class="tocitem" href="../api/encryption.html">Encryption</a></li><li><a class="tocitem" href="../api/exceptions.html">Exceptions</a></li><li><a class="tocitem" href="../api/filetemplates.html">FileTemplates</a></li><li><a class="tocitem" href="../api/flash.html">Flash</a></li><li><a class="tocitem" href="../api/generator.html">Generator</a></li><li><a class="tocitem" href="../api/genie.html">Genie</a></li><li><a class="tocitem" href="../api/headers.html">Headers</a></li><li><a class="tocitem" href="../api/httputils.html">HttpUtils</a></li><li><a class="tocitem" href="../api/input.html">Input</a></li><li><a class="tocitem" href="../api/plugins.html">Plugins</a></li><li><a class="tocitem" href="../api/renderer.html">Renderer</a></li><li><a class="tocitem" href="../api/renderer-html.html">HTML Renderer</a></li><li><a class="tocitem" href="../api/renderer-js.html">JS Renderer</a></li><li><a class="tocitem" href="../api/renderer-json.html">JSON Renderer</a></li><li><a class="tocitem" href="../api/requests.html">Requests</a></li><li><a class="tocitem" href="../api/responses.html">Responses</a></li><li><a class="tocitem" href="../api/router.html">Router</a></li><li><a class="tocitem" href="../api/sessions.html">Sessions</a></li><li><a class="tocitem" href="../api/toolbox.html">Toolbox</a></li><li><a class="tocitem" href="../api/util.html">Util</a></li><li><a class="tocitem" href="../api/webchannels.html">WebChannels</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href="17--Working_with_Web_Sockets.html">Working with WebSockets</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="17--Working_with_Web_Sockets.html">Working with WebSockets</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/GenieFramework/Genie.jl/blob/master/docs/src/tutorials/17--Working_with_Web_Sockets.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Working-with-Web-Sockets"><a class="docs-heading-anchor" href="#Working-with-Web-Sockets">Working with Web Sockets</a><a id="Working-with-Web-Sockets-1"></a><a class="docs-heading-anchor-permalink" href="#Working-with-Web-Sockets" title="Permalink"></a></h1><p>Genie provides a powerful workflow for client-server communication over websockets. The system hides away the complexity of the network level communication, exposing powerful abstractions which resemble Genie&#39;s familiar MVC workflow: the clients and the server exchange messages over <code>channels</code> (which are the equivalent of <code>routes</code>).</p><h2 id="Registering-channels"><a class="docs-heading-anchor" href="#Registering-channels">Registering <code>channels</code></a><a id="Registering-channels-1"></a><a class="docs-heading-anchor-permalink" href="#Registering-channels" title="Permalink"></a></h2><p>The messages are mapped to a matching channel, where are processed by Genie&#39;s <code>Router</code> which extracts the payload and invokes the designated handler (controller method or function). For most purposes, the <code>channels</code> are the functional equivalents of <code>routes</code> and are defined in the same way:</p><pre><code class="language-julia hljs">using Genie.Router

channel(&quot;/foo/bar&quot;) do
  # process request
end

channel(&quot;/baz/bax&quot;, YourController.your_handler)</code></pre><p>The above <code>channel</code> definitions will handle websocket messages sent to <code>/foo/bar</code> and <code>/baz/bax</code>.</p><h2 id="Setting-up-the-client"><a class="docs-heading-anchor" href="#Setting-up-the-client">Setting up the client</a><a id="Setting-up-the-client-1"></a><a class="docs-heading-anchor-permalink" href="#Setting-up-the-client" title="Permalink"></a></h2><p>In order to enable WebSockets communication in the browser we need to load a JavaScript file. This is provided by Genie, through the <code>Assets</code> module. Genie makes it extremely easy to setup the WebSockets infrastructure on the client side, by providing the <code>Assets.channels_support()</code> method. For instance, if we want to add support for WebSockets to the root page of a web app, all we need is this:</p><pre><code class="language-julia hljs">using Genie.Router, Genie.Assets

route(&quot;/&quot;) do
  Assets.channels_support()
end</code></pre><p>Literally, that is all we need in order to be able to push and receive messages between client and server.</p><hr/><h2 id="Try-it!"><a class="docs-heading-anchor" href="#Try-it!">Try it!</a><a id="Try-it!-1"></a><a class="docs-heading-anchor-permalink" href="#Try-it!" title="Permalink"></a></h2><p>You can follow through by running the following Julia code in a Julia REPL:</p><pre><code class="language-julia hljs">using Genie, Genie.Router, Genie.Assets

Genie.config.websockets_server = true # enable the websockets server

route(&quot;/&quot;) do
  Assets.channels_support()
end

up() # start the servers</code></pre><p>Now if you visit <a href="http://localhost:8000">http://localhost:8000</a> you&#39;ll get a blank page – which, however, includes all the necessary functionality for WebSockets communication! If you use the browser&#39;s developer tools, the Network pane will indicate that a <code>channels.js</code> file was loaded and that a WebSockets request was made (Status 101 over GET). Additionally, if you peek at the Console, you will see a <code>Subscription ready</code> message. The output in the console should be something like:</p><pre><code class="language-text hljs">Queuing subscription channels.js:107:13
Subscription ready channels.js:105:13
OK channels.js:74:11
Overwrite window.parse_payload to handle messages from the server channels.js:98:11
OK</code></pre><p>** What happened? **</p><p>At this point, by invoking <code>Assets.channels_support()</code>, Genie has done the following:</p><ul><li>loaded the bundled the <code>channels.js</code> file which provides a JS API for communicating over WebSockets</li><li>has created two default channels, for subscribing and unsubscribing: <code>/__/subscribe</code> and <code>/__/unsubscribe</code></li><li>has invoked <code>/__/subscribe</code> and created a WebSockets connection between client and server</li></ul><h3 id="Pushing-messages-from-the-server"><a class="docs-heading-anchor" href="#Pushing-messages-from-the-server">Pushing messages from the server</a><a id="Pushing-messages-from-the-server-1"></a><a class="docs-heading-anchor-permalink" href="#Pushing-messages-from-the-server" title="Permalink"></a></h3><p>We are ready to interact with the client. Go to the Julia REPL running the web app and run:</p><pre><code class="language-julia hljs">julia&gt; Genie.WebChannels.connected_clients()
1-element Array{Genie.WebChannels.ChannelClient,1}:
 Genie.WebChannels.ChannelClient(HTTP.WebSockets.WebSocket{HTTP.ConnectionPool.Transaction{Sockets.TCPSocket}}(T0  🔁    0↑🔒    0↓🔒 100s 127.0.0.1:8001:8001 ≣16, 0x01, true, UInt8[0x7b, 0x22, 0x63, 0x68, 0x61, 0x6e, 0x6e, 0x65, 0x6c, 0x22  …  0x79, 0x6c, 0x6f, 0x61, 0x64, 0x22, 0x3a, 0x7b, 0x7d, 0x7d], UInt8[], false, false), [&quot;__&quot;])</code></pre><p>We have one connected client to the <code>__</code> channel! We can send it a message:</p><pre><code class="language-julia hljs">julia&gt; Genie.WebChannels.broadcast(&quot;__&quot;, &quot;Hey!&quot;)
true</code></pre><p>If you look in the browser&#39;s console you will see the &quot;Hey!&quot; message! By default, the client side handler simply outputs the message. We&#39;re also informed that we can &quot;Overwrite window.parse_payload to handle messages from the server&quot;. Let&#39;s do it. Run this in the current REPL (it will overwrite our root route handler):</p><pre><code class="language-julia hljs">route(&quot;/&quot;) do
  Assets.channels_support() *
  &quot;&quot;&quot;
  &lt;script&gt;
  window.parse_payload = function(payload) {
    console.log(&#39;Got this payload: &#39; + payload);
  }
  &lt;/script&gt;
  &quot;&quot;&quot;
end</code></pre><p>Now if you reload the page and broadcast the message, it will be picked up by our custom payload handler. However, chances are you&#39;ll also get an error when broadcasting (don&#39;t worry though, the error is just logged, it&#39;s not breaking the application as it&#39;s not critical):</p><pre><code class="language-julia hljs">julia&gt; Genie.WebChannels.broadcast(&quot;__&quot;, &quot;Hey!&quot;)
┌ Error: Base.IOError(&quot;stream is closed or unusable&quot;, 0)
└ @ Genie.WebChannels ~/.julia/dev/Genie/src/WebChannels.jl:220
true</code></pre><p>The error is caused by the fact that, by reloading the page, our previously connected WebSockets client is now unreachable. However, we still keep a reference to it - and when we try to broadcast to it, we find that the stream has been closed. We can fix this by calling</p><pre><code class="language-julia hljs">julia&gt; Genie.WebChannels.unsubscribe_disconnected_clients()</code></pre><p>The output of <code>unsubscribe_disconnected_clients()</code> is the collection of remaining (connected) clients.</p><hr/><p>** Heads up! **</p><p>Although harmless, the error indicates that you have disconnected clients in memory. If you don&#39;t need the data, purge them to free memory.</p><hr/><p>At any time, we can check the connected clients with <code>Genie.WebChannels.connected_clients()</code> and the disconnected ones with <code>Genie.WebChannels.disconnected_clients()</code>.</p><h3 id="Pushing-messages-from-the-client"><a class="docs-heading-anchor" href="#Pushing-messages-from-the-client">Pushing messages from the client</a><a id="Pushing-messages-from-the-client-1"></a><a class="docs-heading-anchor-permalink" href="#Pushing-messages-from-the-client" title="Permalink"></a></h3><p>We can also push messages from client to server. As we don&#39;t have a UI, we&#39;ll use the browser&#39;s console and Genie&#39;s JavaScript API to send the message. But first, we need to set up the <code>channel</code> which will receive our message. Run this in the active Julia REPL:</p><pre><code class="language-julia hljs">channel(&quot;/__/echo&quot;) do
  &quot;Received: $(params(:payload))&quot;
end</code></pre><p>Now that our endpoint is up, go to the browser&#39;s console and run:</p><pre><code class="language-javascript hljs">Genie.WebChannels.sendMessageTo(&#39;__&#39;, &#39;echo&#39;, &#39;Hello!&#39;)</code></pre><p>The console will immediately display the response from the server:</p><pre><code class="language-text hljs">Received: Hello!  channels.js:74:3
Got this payload: Received: Hello!</code></pre><h2 id="Summary"><a class="docs-heading-anchor" href="#Summary">Summary</a><a id="Summary-1"></a><a class="docs-heading-anchor-permalink" href="#Summary" title="Permalink"></a></h2><p>This concludes our intro to working with WebSockets in Genie. You now have the knowledge to set up the communication between client and server, send messages from both server and clients, and perform various tasks using the <code>WebChannels</code> API.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="16--Using_Genie_With_Docker.html">« Using Genie with Docker</a><a class="docs-footer-nextpage" href="80--Force_Compiling_Routes.html">Force compiling route handlers »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.12 on <span class="colophon-date" title="Friday 11 February 2022 19:16">Friday 11 February 2022</span>. Using Julia version 1.7.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
